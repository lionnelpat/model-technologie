name: Deploy to VPS

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
    paths:
      - 'devops/**'
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment Ã  dÃ©ployer'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io

jobs:
  determine-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      deploy: ${{ steps.set-env.outputs.deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ needs.determine-env.outputs.environment }}
    needs: determine-env
    environment: ${{ needs.determine-env.outputs.environment }}

    # Ne pas dÃ©ployer si ce n'est pas prÃ©vu
    if: needs.determine-env.outputs.deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Determine VPS Host
        id: vps-config
        run: |
          if [[ "${{ needs.determine-env.outputs.environment }}" == "production" ]]; then
            echo "Host is set to VPS_HOST_PROD"
          else
            echo "Host is set to VPS_HOST_STAGING"
          fi

      - name: Add to known_hosts (Production)
        if: needs.determine-env.outputs.environment == 'production'
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST_PROD }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "âœ… SSH key added for production VPS"

      - name: Add to known_hosts (Staging)
        if: needs.determine-env.outputs.environment == 'staging'
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST_STAGING }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "âœ… SSH key added for staging VPS"

      - name: Get image tags
        id: tags
        run: |
          if [[ "${{ needs.determine-env.outputs.environment }}" == "production" ]]; then
            echo "frontend-tag=latest" >> $GITHUB_OUTPUT
            echo "backend-tag=latest" >> $GITHUB_OUTPUT
          else
            echo "frontend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "backend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          ENVIRONMENT=$1
          FRONTEND_TAG=$2
          BACKEND_TAG=$3
          REGISTRY=$4
          IMAGE_FRONTEND=$5
          IMAGE_BACKEND=$6
          
          echo "ðŸš€ DÃ©ploiement vers $ENVIRONMENT"
          echo "Frontend image: $IMAGE_FRONTEND:$FRONTEND_TAG"
          echo "Backend image: $IMAGE_BACKEND:$BACKEND_TAG"
          
          # CrÃ©er les rÃ©pertoires s'ils n'existent pas
          mkdir -p /home/deploy/model-tech/devops
          
          # TÃ©lÃ©charger docker-compose
          if [ "$ENVIRONMENT" == "production" ]; then
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.prod.yml pull
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.prod.yml up -d
          else
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.yml pull
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.yml up -d
          fi
          
          # Health check
          echo "ðŸ¥ VÃ©rification santÃ© de l'application..."
          sleep 10
          curl -f http://localhost:8080/api/actuator/health || exit 1
          
          echo "âœ… DÃ©ploiement rÃ©ussi !"
          EOF
          
          chmod +x deploy.sh

      - name: Deploy to Production
        if: needs.determine-env.outputs.environment == 'production'
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy.sh \
            deploy@${{ secrets.VPS_HOST_PROD }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy@${{ secrets.VPS_HOST_PROD }} \
            "cd /tmp && bash deploy.sh '${{ needs.determine-env.outputs.environment }}' '${{ steps.tags.outputs.frontend-tag }}' '${{ steps.tags.outputs.backend-tag }}' '${{ env.REGISTRY }}' '${{ env.REGISTRY }}/${{ github.repository }}-frontend' '${{ env.REGISTRY }}/${{ github.repository }}-backend'"

      - name: Deploy to Staging
        if: needs.determine-env.outputs.environment == 'staging'
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy.sh \
            deploy@${{ secrets.VPS_HOST_STAGING }}:/tmp/
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy@${{ secrets.VPS_HOST_STAGING }} \
            "cd /tmp && bash deploy.sh '${{ needs.determine-env.outputs.environment }}' '${{ steps.tags.outputs.frontend-tag }}' '${{ steps.tags.outputs.backend-tag }}' '${{ env.REGISTRY }}' '${{ env.REGISTRY }}/${{ github.repository }}-frontend' '${{ env.REGISTRY }}/${{ github.repository }}-backend'"

      - name: Health check (Production)
        if: needs.determine-env.outputs.environment == 'production'
        run: |
          echo "ðŸ” VÃ©rification finale..."
          sleep 5
          curl -f https://model-technologie.com/api/actuator/health || \
          curl -f http://${{ secrets.VPS_HOST_PROD }}:8080/api/actuator/health || \
          exit 1

      - name: Health check (Staging)
        if: needs.determine-env.outputs.environment == 'staging'
        run: |
          echo "ðŸ” VÃ©rification finale..."
          sleep 5
          curl -f http://${{ secrets.VPS_HOST_STAGING }}:8080/api/actuator/health || \
          exit 1

      - name: Notify Slack (Success)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… DÃ©ploiement rÃ©ussi !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… DÃ©ploiement rÃ©ussi*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âŒ DÃ©ploiement Ã©chouÃ© !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ DÃ©ploiement Ã©chouÃ©*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Action:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Voir le log>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK