name: Deploy to VPS

on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
    paths:
      - 'devops/**'
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment √† d√©ployer'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io

jobs:
  determine-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      deploy: ${{ steps.set-env.outputs.deploy }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ needs.determine-env.outputs.environment }}
    needs: determine-env
    environment: ${{ needs.determine-env.outputs.environment }}

    # Ne pas d√©ployer si ce n'est pas pr√©vu
    if: needs.determine-env.outputs.deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Determine VPS Host
        id: vps-config
        run: |
          if [[ "${{ needs.determine-env.outputs.environment }}" == "production" ]]; then
            echo "Host is set to VPS_HOST_PROD"
          else
            echo "Host is set to VPS_HOST_STAGING"
          fi

      - name: Add to known_hosts (Production)
        if: needs.determine-env.outputs.environment == 'production'
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST_PROD }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "‚úÖ SSH key added for production VPS"

      - name: Add to known_hosts (Staging)
        if: needs.determine-env.outputs.environment == 'staging'
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST_STAGING }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "‚úÖ SSH key added for staging VPS"

      - name: Get image tags
        id: tags
        run: |
          if [[ "${{ needs.determine-env.outputs.environment }}" == "production" ]]; then
            echo "frontend-tag=latest" >> $GITHUB_OUTPUT
            echo "backend-tag=latest" >> $GITHUB_OUTPUT
          else
            echo "frontend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "backend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          ENVIRONMENT=$1

          # Fonction pour utiliser docker-compose (compatible avec les deux versions)
          docker_compose() {
              if command -v docker-compose &> /dev/null; then
                  docker-compose "$@"
              elif docker compose version &> /dev/null; then
                  docker compose "$@"
              else
                  echo "‚ùå ERREUR: docker-compose n'est pas install√©!"
                  exit 1
              fi
          }

          echo "üöÄ D√©ploiement vers $ENVIRONMENT"
          echo "V√©rification de docker-compose..."
          docker_compose --version

          # Cr√©er les r√©pertoires
          mkdir -p /home/deploy/model-tech/devops
          mkdir -p /home/deploy/model-tech/logs

          echo "‚úÖ Pr√™t pour la Phase 3: Docker & Docker Compose"
          EOF

          chmod +x deploy.sh

      - name: Deploy to Staging
        run: |
          echo "üì§ Transfert du script de d√©ploiement..."
          
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy.sh \
            deploy@${{ secrets.VPS_HOST_STAGING }}:/tmp/
          
          echo "‚úÖ Script transf√©r√©"
          echo "üöÄ Ex√©cution du d√©ploiement..."
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            deploy@${{ secrets.VPS_HOST_STAGING }} \
            "cd /tmp && bash deploy.sh"
          
          echo "‚úÖ D√©ploiement staging termin√©"

#      - name: Deploy to Production
#        if: needs.determine-env.outputs.environment == 'production'
#        run: |
#          scp -i ~/.ssh/deploy_key \
#            -o StrictHostKeyChecking=no \
#            -o ConnectTimeout=10 \
#            deploy.sh \
#            deploy@${{ secrets.VPS_HOST_PROD }}:/tmp/
#
#          ssh -i ~/.ssh/deploy_key \
#            -o StrictHostKeyChecking=no \
#            -o ConnectTimeout=10 \
#            deploy@${{ secrets.VPS_HOST_PROD }} \
#            "cd /tmp && bash deploy.sh '${{ needs.determine-env.outputs.environment }}' '${{ steps.tags.outputs.frontend-tag }}' '${{ steps.tags.outputs.backend-tag }}' '${{ env.REGISTRY }}' '${{ env.REGISTRY }}/${{ github.repository }}-frontend' '${{ env.REGISTRY }}/${{ github.repository }}-backend'"

#      - name: Deploy to Staging
#        if: needs.determine-env.outputs.environment == 'staging'
#        run: |
#          scp -i ~/.ssh/deploy_key \
#            -o StrictHostKeyChecking=no \
#            -o ConnectTimeout=10 \
#            deploy.sh \
#            deploy@${{ secrets.VPS_HOST_STAGING }}:/tmp/
#
#          ssh -i ~/.ssh/deploy_key \
#            -o StrictHostKeyChecking=no \
#            -o ConnectTimeout=10 \
#            deploy@${{ secrets.VPS_HOST_STAGING }} \
#            "cd /tmp && bash deploy.sh '${{ needs.determine-env.outputs.environment }}' '${{ steps.tags.outputs.frontend-tag }}' '${{ steps.tags.outputs.backend-tag }}' '${{ env.REGISTRY }}' '${{ env.REGISTRY }}/${{ github.repository }}-frontend' '${{ env.REGISTRY }}/${{ github.repository }}-backend'"

#      - name: Health check (Production)
#        if: needs.determine-env.outputs.environment == 'production'
#        run: |
#          echo "üîç V√©rification finale..."
#          sleep 5
#          curl -f https://model-technologie.com/api/actuator/health || \
#          curl -f http://${{ secrets.VPS_HOST_PROD }}:8080/api/actuator/health || \
#          exit 1

#      - name: Health check (Staging)
#        if: needs.determine-env.outputs.environment == 'staging'
#        run: |
#          echo "üîç V√©rification finale..."
#          sleep 5
#          curl -f http://${{ secrets.VPS_HOST_STAGING }}:8080/api/actuator/health || \
#          exit 1

      - name: Notify Slack (Success)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚úÖ D√©ploiement r√©ussi !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚úÖ D√©ploiement r√©ussi*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "‚ùå D√©ploiement √©chou√© !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*‚ùå D√©ploiement √©chou√©*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Action:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Voir le log>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK