name: Deploy to VPS

# ðŸ”¥ Se dÃ©clenche APRÃˆS les workflows frontend et backend
# C'est-Ã -dire, une fois les images Docker poussÃ©es
on:
  push:
    branches:
      - main      # Production
      - staging   # Staging
    paths:
      - 'devops/**'
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'

  # Permet aussi un dÃ©ploiement manuel
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment Ã  dÃ©ployer'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io

jobs:
  determine-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      vps-host: ${{ steps.set-env.outputs.vps-host }}
      vps-user: ${{ steps.set-env.outputs.vps-user }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "vps-host=${{ secrets.VPS_HOST_PROD }}" >> $GITHUB_OUTPUT
            echo "vps-user=deploy" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "vps-host=${{ secrets.VPS_HOST_STAGING }}" >> $GITHUB_OUTPUT
            echo "vps-user=deploy" >> $GITHUB_OUTPUT
          fi

  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ needs.determine-env.outputs.environment }}
    needs: determine-env
    environment: ${{ needs.determine-env.outputs.environment }}

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      # Nouvelle Ã©tape - VÃ©rifier que les secrets existent
      - name: Validate environment variables
        run: |
          if [ -z "${{ needs.determine-env.outputs.vps-host }}" ]; then
            echo "âŒ ERREUR: VPS_HOST n'est pas dÃ©fini!"
            exit 1
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ needs.determine-env.outputs.vps-host }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Get image tags
        id: tags
        run: |
          # Pour production: utiliser 'latest'
          # Pour staging: utiliser le hash du commit
          if [[ "${{ needs.determine-env.outputs.environment }}" == "production" ]]; then
            echo "frontend-tag=latest" >> $GITHUB_OUTPUT
            echo "backend-tag=latest" >> $GITHUB_OUTPUT
          else
            echo "frontend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "backend-tag=${{ github.ref_name }}-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          ENVIRONMENT=${{ needs.determine-env.outputs.environment }}
          FRONTEND_TAG=${{ steps.tags.outputs.frontend-tag }}
          BACKEND_TAG=${{ steps.tags.outputs.backend-tag }}
          REGISTRY=${{ env.REGISTRY }}
          IMAGE_FRONTEND=${{ env.REGISTRY }}/${{ github.repository }}-frontend
          IMAGE_BACKEND=${{ env.REGISTRY }}/${{ github.repository }}-backend
          
          echo "ðŸš€ DÃ©ploiement vers $ENVIRONMENT"
          echo "Frontend image: $IMAGE_FRONTEND:$FRONTEND_TAG"
          echo "Backend image: $IMAGE_BACKEND:$BACKEND_TAG"
          
          # CrÃ©er les rÃ©pertoires s'ils n'existent pas
          mkdir -p /home/deploy/model-tech/devops
          
          # TÃ©lÃ©charger docker-compose
          if [ "$ENVIRONMENT" == "production" ]; then
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.prod.yml pull
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.prod.yml up -d
          else
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.yml pull
            docker-compose -f /home/deploy/model-tech/devops/docker-compose.yml up -d
          fi
          
          # Health check
          echo "ðŸ¥ VÃ©rification santÃ© de l'application..."
          sleep 10
          curl -f http://localhost:8080/actuator/health || exit 1
          
          echo "âœ… DÃ©ploiement rÃ©ussi !"
          EOF
          
          chmod +x deploy.sh

      - name: Copy deployment script to VPS
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            deploy.sh \
            ${{ needs.determine-env.outputs.vps-user }}@${{ needs.determine-env.outputs.vps-host }}:/tmp/

      - name: Execute deployment
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            ${{ needs.determine-env.outputs.vps-user }}@${{ needs.determine-env.outputs.vps-host }} \
            "cd /tmp && bash deploy.sh"

      - name: Health check
        run: |
          echo "ðŸ” VÃ©rification finale..."
          sleep 5
          curl -f https://model-technologie.com/api/actuator/health || \
          curl -f http://${{ needs.determine-env.outputs.vps-host }}:8080/api/actuator/health || \
          exit 1

      - name: Notify Slack (Success)
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… DÃ©ploiement rÃ©ussi !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âœ… DÃ©ploiement rÃ©ussi*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify Slack (Failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âŒ DÃ©ploiement Ã©chouÃ© !",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*âŒ DÃ©ploiement Ã©chouÃ©*\n*Environnement:* ${{ needs.determine-env.outputs.environment }}\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref_name }}\n*Action:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Voir le log>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK